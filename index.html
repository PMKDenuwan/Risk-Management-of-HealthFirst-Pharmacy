<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthFirst Pharmacy - Advanced Management System</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #10b981;
            --secondary-dark: #059669;
            --accent: #f59e0b;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --dark: #1f2937;
            --light: #f8fafc;
            --border: #e2e8f0;
            --text: #374151;
            --text-light: #6b7280;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--glass-border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
        }

        .logo-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            font-weight: bold;
            box-shadow: var(--shadow);
            position: relative;
        }

        .logo-icon::before {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            z-index: -1;
            opacity: 0.3;
        }

        .logo h1 {
            color: var(--dark);
            font-size: 2.8em;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo p {
            color: var(--text-light);
            font-size: 1.2em;
            font-weight: 500;
        }

        .login-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--light), #ffffff);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid var(--border);
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .nav-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .nav-tab {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 2px solid var(--glass-border);
            padding: 18px 28px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .nav-tab:hover::before {
            left: 100%;
        }

        .nav-tab:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-color: var(--primary);
        }

        .system-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 35px;
            box-shadow: var(--shadow);
            border: 1px solid var(--glass-border);
            min-height: 700px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 35px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--border);
            position: relative;
        }

        .panel-header::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 2px;
        }

        .panel-title {
            font-size: 2.2em;
            color: var(--dark);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .panel-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--text-light), #4b5563);
            box-shadow: 0 4px 15px rgba(75, 85, 99, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .btn-icon {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .form-group {
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 15px 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: white;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            transform: translateY(-1px);
        }

        .search-container {
            position: relative;
            margin-bottom: 25px;
        }

        .search-bar {
            width: 100%;
            padding: 18px 50px 18px 20px;
            border: 2px solid var(--border);
            border-radius: 15px;
            font-size: 16px;
            background: white;
            transition: all 0.3s ease;
        }

        .search-bar:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            font-size: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .data-table th,
        .data-table td {
            padding: 18px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table tr {
            transition: all 0.2s ease;
        }

        .data-table tr:hover {
            background: #f1f5f9;
            transform: scale(1.01);
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #15803d;
        }

        .status-warning {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
        }

        .status-danger {
            background: linear-gradient(135deg, #fecaca, #fca5a5);
            color: #991b1b;
        }

        .status-pending {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1d4ed8;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
        }

        .stat-number {
            font-size: 3em;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            line-height: 1;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            margin: 0 auto 15px;
        }

        .alert {
            padding: 18px 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert-success {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #15803d;
            border-left: 4px solid #22c55e;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }

        .alert-danger {
            background: linear-gradient(135deg, #fecaca, #fca5a5);
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        .alert-info {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1d4ed8;
            border-left: 4px solid #3b82f6;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            margin: 3% auto;
            padding: 40px;
            border-radius: 20px;
            width: 95%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            position: relative;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .modal-title {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--dark);
        }

        .close {
            background: var(--border);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            color: var(--text);
            transition: all 0.3s ease;
        }

        .close:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            animation: slideInRight 0.3s ease;
            box-shadow: var(--shadow-lg);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            background: var(--primary);
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .table-actions {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .nav-tabs {
                flex-direction: column;
                gap: 10px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .panel-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 20px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .data-table {
                font-size: 14px;
            }
            
            .data-table th,
            .data-table td {
                padding: 12px 15px;
            }
            
            .modal-content {
                margin: 10% auto;
                width: 95%;
                padding: 25px;
            }
            
            .logo h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">H+</div>
                <div>
                    <h1>HealthFirst Pharmacy</h1>
                    <p>Advanced Healthcare Management System</p>
                </div>
            </div>
            
            <div class="login-section">
                <div id="loginForm">
                    <h3 style="margin-bottom: 20px; color: var(--dark); font-size: 1.5em;">System Access</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>User Role:</label>
                            <select id="userRole">
                                <option value="">Select Role</option>
                                <option value="pharmacist">Pharmacist</option>
                                <option value="it_operator">IT Operator</option>
                                <option value="representative">Representative</option>
                                <option value="healthcare_provider">Healthcare Provider</option>
                                <option value="admin">System Administrator</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Username:</label>
                            <input type="text" id="username" placeholder="Enter username">
                        </div>
                        <div class="form-group">
                            <label>Password:</label>
                            <input type="password" id="password" placeholder="Enter password">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-icon" onclick="login()">
                                <span>🔐</span> Login
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="userInfo" class="user-info hidden">
                    <div class="user-badge">
                        <div class="user-avatar" id="userAvatar"></div>
                        <div>
                            <strong>Welcome back,</strong> <span id="currentUser"></span><br>
                            <small>Role: <span id="currentRole"></span></small>
                        </div>
                    </div>
                    <button class="btn btn-secondary btn-icon" onclick="logout()">
                        <span>🚪</span> Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs" id="navigationTabs">
            <button class="nav-tab active" onclick="showPanel('dashboard')">
                <span style="margin-right: 8px;">📊</span> Dashboard
            </button>
            <button class="nav-tab" onclick="showPanel('emr')" id="emrTab">
                <span style="margin-right: 8px;">👥</span> Patient Records
            </button>
            <button class="nav-tab" onclick="showPanel('prescriptions')" id="prescTab">
                <span style="margin-right: 8px;">💊</span> Prescriptions
            </button>
            <button class="nav-tab" onclick="showPanel('inventory')" id="inventoryTab">
                <span style="margin-right: 8px;">📦</span> Inventory
            </button>
            <button class="nav-tab" onclick="showPanel('reports')" id="reportsTab">
                <span style="margin-right: 8px;">📈</span> Reports
            </button>
            <button class="nav-tab" onclick="showPanel('settings')" id="settingsTab">
                <span style="margin-right: 8px;">⚙️</span> Settings
            </button>
        </div>

        <!-- Dashboard Panel -->
        <div id="dashboardPanel" class="system-panel">
            <div class="panel-header">
                <h2 class="panel-title">
                    <div class="panel-icon">📊</div>
                    System Dashboard
                </h2>
                <button class="btn btn-success btn-icon" onclick="refreshDashboard()">
                    <span>🔄</span> Refresh
                </button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">👥</div>
                    <div class="stat-number" id="totalPatients">0</div>
                    <div class="stat-label">Total Patients</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 75%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">💊</div>
                    <div class="stat-number" id="activePrescriptions">0</div>
                    <div class="stat-label">Active Prescriptions</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 60%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📦</div>
                    <div class="stat-number" id="inventoryItems">0</div>
                    <div class="stat-label">Inventory Items</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 85%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">⚠️</div>
                    <div class="stat-number" id="lowStockItems">0</div>
                    <div class="stat-label">Low Stock Alerts</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 25%"></div>
                    </div>
                </div>
            </div>

            <div id="systemAlerts"></div>
            
            <div class="card">
                <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <span>📋</span> Recent Activity
                </h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>System</th>
                            <th>Action</th>
                            <th>User</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="activityLog">
                        <!-- Activity logs will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- EMR System Panel -->
        <div id="emrPanel" class="system-panel hidden">
            <div class="panel-header">
                <h2 class="panel-title">
                    <div class="panel-icon">👥</div>
                    Patient Records System
                </h2>
                <button class="btn btn-icon" onclick="showModal('addPatientModal')">
                    <span>➕</span> Add New Patient
                </button>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary btn-icon" onclick="exportPatients()">
                    <span>📊</span> Export Data
                </button>
                <button class="btn btn-warning btn-icon" onclick="bulkImport()">
                    <span>📥</span> Import Data
                </button>
                <button class="btn btn-success btn-icon" onclick="generatePatientReport()">
                    <span>📄</span> Generate Report
                </button>
            </div>

            <div class="search-container">
                <input type="text" class="search-bar" id="patientSearch" placeholder="Search patients by name, ID, or contact..." onkeyup="searchPatients()">
                <span class="search-icon">🔍</span>
            </div>
            
            <div class="card">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Patient ID</th>
                            <th>Name</th>
                            <th>Age</th>
                            <th>Contact</th>
                            <th>Last Visit</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="patientsTable">
                        <!-- Patient data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Prescription Database Panel -->
        <div id="prescriptionsPanel" class="system-panel hidden">
            <div class="panel-header">
                <h2 class="panel-title">
                    <div class="panel-icon">💊</div>
                    Prescription Management
                </h2>
                <button class="btn btn-icon" onclick="showModal('addPrescriptionModal')">
                    <span>➕</span> New Prescription
                </button>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary btn-icon" onclick="checkInteractions()">
                    <span>⚠️</span> Check Interactions
                </button>
                <button class="btn btn-warning btn-icon" onclick="renewalReminders()">
                    <span>🔔</span> Renewal Reminders
                </button>
                <button class="btn btn-success btn-icon" onclick="generatePrescriptionReport()">
                    <span>📊</span> Analytics
                </button>
            </div>

            <div class="search-container">
                <input type="text" class="search-bar" id="prescriptionSearch" placeholder="Search by patient, medication, or prescription ID..." onkeyup="searchPrescriptions()">
                <span class="search-icon">🔍</span>
            </div>
            
            <div class="card">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Prescription ID</th>
                            <th>Patient</th>
                            <th>Medication</th>
                            <th>Dosage</th>
                            <th>Prescribed Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="prescriptionsTable">
                        <!-- Prescription data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Inventory Management Panel -->
        <div id="inventoryPanel" class="system-panel hidden">
            <div class="panel-header">
                <h2 class="panel-title">
                    <div class="panel-icon">📦</div>
                    Inventory Management
                </h2>
                <button class="btn btn-icon" onclick="showModal('addInventoryModal')">
                    <span>➕</span> Add Item
                </button>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary btn-icon" onclick="generateFinancialReport()">
                    <span>💰</span> Financial Report
                </button>
                <button class="btn btn-warning btn-icon" onclick="checkLowStock()">
                    <span>📉</span> Low Stock Check
                </button>
                <button class="btn btn-danger btn-icon" onclick="expiryAlert()">
                    <span>⏰</span> Expiry Alerts
                </button>
                <button class="btn btn-success btn-icon" onclick="stockOptimization()">
                    <span>📈</span> Optimize Stock
                </button>
            </div>
            
            <div class="search-container">
                <input type="text" class="search-bar" id="inventorySearch" placeholder="Search by item name, supplier, or category..." onkeyup="searchInventory()">
                <span class="search-icon">🔍</span>
            </div>
            
            <div class="card">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Item ID</th>
                            <th>Item Name</th>
                            <th>Supplier</th>
                            <th>Stock Level</th>
                            <th>Unit Price</th>
                            <th>Expiry Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTable">
                        <!-- Inventory data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Reports Panel -->
        <div id="reportsPanel" class="system-panel hidden">
            <div class="panel-header">
                <h2 class="panel-title">
                    <div class="panel-icon">📈</div>
                    Reports & Analytics
                </h2>
                <button class="btn btn-icon" onclick="scheduleReport()">
                    <span>⏰</span> Schedule Report
                </button>
            </div>

            <div class="stats-grid">
                <div class="card" onclick="generateSalesReport()">
                    <div class="stat-icon">💰</div>
                    <h3>Sales Analytics</h3>
                    <p>Revenue, trends, and performance metrics</p>
                    <button class="btn btn-sm">Generate Report</button>
                </div>
                <div class="card" onclick="generatePatientReport()">
                    <div class="stat-icon">👥</div>
                    <h3>Patient Analytics</h3>
                    <p>Demographics, visit patterns, treatments</p>
                    <button class="btn btn-sm">Generate Report</button>
                </div>
                <div class="card" onclick="generateInventoryReport()">
                    <div class="stat-icon">📦</div>
                    <h3>Inventory Reports</h3>
                    <p>Stock levels, turnover, procurement</p>
                    <button class="btn btn-sm">Generate Report</button>
                </div>
                <div class="card" onclick="generateComplianceReport()">
                    <div class="stat-icon">📋</div>
                    <h3>Compliance Reports</h3>
                    <p>Regulatory compliance and audits</p>
                    <button class="btn btn-sm">Generate Report</button>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 20px;">Custom Report Builder</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Report Type:</label>
                        <select id="reportType">
                            <option value="sales">Sales Report</option>
                            <option value="inventory">Inventory Report</option>
                            <option value="patient">Patient Report</option>
                            <option value="prescription">Prescription Report</option>
                            <option value="financial">Financial Report</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date Range:</label>
                        <select id="dateRange">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="year">This Year</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Format:</label>
                        <select id="reportFormat">
                            <option value="pdf">PDF</option>
                            <option value="excel">Excel</option>
                            <option value="csv">CSV</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-success btn-icon" onclick="generateCustomReport()">
                            <span>📊</span> Generate Report
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Panel -->
        <div id="settingsPanel" class="system-panel hidden">
            <div class="panel-header">
                <h2 class="panel-title">
                    <div class="panel-icon">⚙️</div>
                    System Settings
                </h2>
                <button class="btn btn-warning btn-icon" onclick="backupSystem()">
                    <span>💾</span> Backup System
                </button>
            </div>

            <div class="form-grid">
                <div class="card">
                    <h3>🔐 Security Settings</h3>
                    <div class="form-group">
                        <label>Password Policy:</label>
                        <select id="passwordPolicy">
                            <option value="basic">Basic (8+ characters)</option>
                            <option value="standard">Standard (8+ chars, mixed case)</option>
                            <option value="strict">Strict (12+ chars, symbols required)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Session Timeout (minutes):</label>
                        <input type="number" id="sessionTimeout" value="30" min="5" max="120">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableMFA"> Enable Multi-Factor Authentication
                        </label>
                    </div>
                </div>

                <div class="card">
                    <h3>🏥 System Configuration</h3>
                    <div class="form-group">
                        <label>Pharmacy Name:</label>
                        <input type="text" id="pharmacyName" value="HealthFirst Pharmacy">
                    </div>
                    <div class="form-group">
                        <label>License Number:</label>
                        <input type="text" id="licenseNumber" placeholder="Enter license number">
                    </div>
                    <div class="form-group">
                        <label>Time Zone:</label>
                        <select id="timeZone">
                            <option value="UTC+5:30">Asia/Colombo (UTC+5:30)</option>
                            <option value="UTC">UTC</option>
                            <option value="UTC-5">US Eastern</option>
                            <option value="UTC-8">US Pacific</option>
                        </select>
                    </div>
                </div>

                <div class="card">
                    <h3>🔔 Notification Settings</h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="emailNotifications" checked> Email Notifications
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="smsNotifications"> SMS Notifications
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="lowStockAlerts" checked> Low Stock Alerts
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="expiryAlerts" checked> Expiry Alerts
                        </label>
                    </div>
                </div>

                <div class="card">
                    <h3>📊 Data Management</h3>
                    <div class="action-buttons">
                        <button class="btn btn-secondary btn-icon" onclick="exportAllData()">
                            <span>📤</span> Export All Data
                        </button>
                        <button class="btn btn-warning btn-icon" onclick="importData()">
                            <span>📥</span> Import Data
                        </button>
                        <button class="btn btn-danger btn-icon" onclick="resetSystem()">
                            <span>🔄</span> Reset System
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <button class="btn btn-success btn-icon" onclick="saveSettings()">
                    <span>💾</span> Save All Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Patient Modal -->
    <div id="addPatientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">👤 Add New Patient</h2>
                <button class="close" onclick="closeModal('addPatientModal')">×</button>
            </div>
            <form onsubmit="addPatient(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Full Name:</label>
                        <input type="text" id="patientName" required>
                    </div>
                    <div class="form-group">
                        <label>Date of Birth:</label>
                        <input type="date" id="patientDOB" required>
                    </div>
                    <div class="form-group">
                        <label>Gender:</label>
                        <select id="patientGender" required>
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Contact Number:</label>
                        <input type="tel" id="patientContact" required>
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="patientEmail">
                    </div>
                    <div class="form-group">
                        <label>Address:</label>
                        <textarea id="patientAddress" rows="2"></textarea>
                    </div>
                </div>
                <div class="form-group">
                    <label>Medical History:</label>
                    <textarea id="medicalHistory" rows="3" placeholder="Enter relevant medical history..."></textarea>
                </div>
                <div class="form-group">
                    <label>Current Medications:</label>
                    <textarea id="currentMedications" rows="2" placeholder="List current medications..."></textarea>
                </div>
                <div class="form-group">
                    <label>Allergies:</label>
                    <textarea id="allergies" rows="2" placeholder="Enter known allergies..."></textarea>
                </div>
                <div class="form-group">
                    <label>Emergency Contact:</label>
                    <input type="text" id="emergencyContact" placeholder="Name and phone number">
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-success btn-icon">
                        <span>✅</span> Add Patient
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addPatientModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Prescription Modal -->
    <div id="addPrescriptionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">💊 New Prescription</h2>
                <button class="close" onclick="closeModal('addPrescriptionModal')">×</button>
            </div>
            <form onsubmit="addPrescription(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Patient:</label>
                        <select id="prescriptionPatient" required>
                            <option value="">Select Patient</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Prescribing Doctor:</label>
                        <input type="text" id="prescribingDoctor" required>
                    </div>
                    <div class="form-group">
                        <label>Medication:</label>
                        <input type="text" id="medication" required>
                    </div>
                    <div class="form-group">
                        <label>Strength/Dosage:</label>
                        <input type="text" id="dosage" required placeholder="e.g., 500mg">
                    </div>
                    <div class="form-group">
                        <label>Frequency:</label>
                        <select id="frequency" required>
                            <option value="">Select Frequency</option>
                            <option value="Once daily">Once daily</option>
                            <option value="Twice daily">Twice daily</option>
                            <option value="Three times daily">Three times daily</option>
                            <option value="Four times daily">Four times daily</option>
                            <option value="As needed">As needed (PRN)</option>
                            <option value="Every 4 hours">Every 4 hours</option>
                            <option value="Every 6 hours">Every 6 hours</option>
                            <option value="Every 8 hours">Every 8 hours</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Duration (days):</label>
                        <input type="number" id="duration" required min="1">
                    </div>
                    <div class="form-group">
                        <label>Quantity to Dispense:</label>
                        <input type="number" id="quantity" required min="1">
                    </div>
                    <div class="form-group">
                        <label>Route of Administration:</label>
                        <select id="route">
                            <option value="Oral">Oral</option>
                            <option value="Topical">Topical</option>
                            <option value="Injection">Injection</option>
                            <option value="Inhaled">Inhaled</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Special Instructions:</label>
                    <textarea id="instructions" rows="3" placeholder="e.g., Take with food, avoid alcohol..."></textarea>
                </div>
                <div class="form-group">
                    <label>Drug Interactions/Warnings:</label>
                    <textarea id="warnings" rows="2" placeholder="Enter any warnings or interactions..."></textarea>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-success btn-icon">
                        <span>✅</span> Add Prescription
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addPrescriptionModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Inventory Modal -->
    <div id="addInventoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">📦 Add Inventory Item</h2>
                <button class="close" onclick="closeModal('addInventoryModal')">×</button>
            </div>
            <form onsubmit="addInventoryItem(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Item Name:</label>
                        <input type="text" id="itemName" required>
                    </div>
                    <div class="form-group">
                        <label>Generic Name:</label>
                        <input type="text" id="genericName">
                    </div>
                    <div class="form-group">
                        <label>Category:</label>
                        <select id="itemCategory" required>
                            <option value="">Select Category</option>
                            <option value="Prescription">Prescription Drugs</option>
                            <option value="OTC">Over-the-Counter</option>
                            <option value="Supplement">Supplements</option>
                            <option value="Medical Device">Medical Devices</option>
                            <option value="First Aid">First Aid</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Supplier:</label>
                        <input type="text" id="supplier" required>
                    </div>
                    <div class="form-group">
                        <label>Batch Number:</label>
                        <input type="text" id="batchNumber" required>
                    </div>
                    <div class="form-group">
                        <label>Stock Quantity:</label>
                        <input type="number" id="stockQuantity" required min="0">
                    </div>
                    <div class="form-group">
                        <label>Unit Price ($):</label>
                        <input type="number" id="unitPrice" step="0.01" required min="0">
                    </div>
                    <div class="form-group">
                        <label>Selling Price ($):</label>
                        <input type="number" id="sellingPrice" step="0.01" required min="0">
                    </div>
                    <div class="form-group">
                        <label>Minimum Stock Level:</label>
                        <input type="number" id="minStockLevel" required min="1">
                    </div>
                    <div class="form-group">
                        <label>Manufacturing Date:</label>
                        <input type="date" id="mfgDate" required>
                    </div>
                    <div class="form-group">
                        <label>Expiry Date:</label>
                        <input type="date" id="expiryDate" required>
                    </div>
                    <div class="form-group">
                        <label>Storage Conditions:</label>
                        <select id="storageConditions">
                            <option value="Room Temperature">Room Temperature</option>
                            <option value="Refrigerated">Refrigerated (2-8°C)</option>
                            <option value="Frozen">Frozen (-20°C)</option>
                            <option value="Cool, Dry Place">Cool, Dry Place</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description/Notes:</label>
                    <textarea id="itemDescription" rows="2" placeholder="Additional notes about the item..."></textarea>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-success btn-icon">
                        <span>✅</span> Add Item
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addInventoryModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Patient Details Modal -->
    <div id="patientDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">👤 Patient Details</h2>
                <button class="close" onclick="closeModal('patientDetailsModal')">×</button>
            </div>
            <div id="patientDetailsContent">
                <!-- Patient details will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let currentUser = null;
        let currentRole = null;
        let patients = [];
        let prescriptions = [];
        let inventory = [];
        let activityLog = [];
        let systemSettings = {
            pharmacyName: 'HealthFirst Pharmacy',
            sessionTimeout: 30,
            enableMFA: false,
            notifications: {
                email: true,
                sms: false,
                lowStock: true,
                expiry: true
            }
        };

        // Enhanced Sample Data
        function initializeSampleData() {
            patients = [
                {
                    id: 'P001',
                    name: 'John Doe',
                    dob: '1978-05-15',
                    age: 45,
                    gender: 'Male',
                    contact: '+94771234567',
                    email: 'john.doe@email.com',
                    address: '123 Main Street, Colombo 07',
                    medicalHistory: 'Hypertension (2019), Type 2 Diabetes (2020), Hyperlipidemia',
                    currentMedications: 'Metformin 500mg BID, Lisinopril 10mg OD',
                    allergies: 'Penicillin (severe reaction), Sulfa drugs',
                    emergencyContact: 'Jane Doe - +94771234568',
                    lastVisit: '2024-08-10',
                    status: 'Active',
                    registrationDate: '2019-03-15'
                },
                {
                    id: 'P002',
                    name: 'Maria Silva',
                    dob: '1992-09-22',
                    age: 32,
                    gender: 'Female',
                    contact: '+94772345678',
                    email: 'maria.silva@email.com',
                    address: '456 Galle Road, Mount Lavinia',
                    medicalHistory: 'Asthma (childhood onset), Seasonal allergies',
                    currentMedications: 'Salbutamol inhaler PRN, Montelukast 10mg OD',
                    allergies: 'Aspirin, Shellfish',
                    emergencyContact: 'Carlos Silva - +94772345679',
                    lastVisit: '2024-08-08',
                    status: 'Active',
                    registrationDate: '2020-07-10'
                },
                {
                    id: 'P003',
                    name: 'Ahmed Hassan',
                    dob: '1965-12-03',
                    age: 58,
                    gender: 'Male',
                    contact: '+94773456789',
                    email: 'ahmed.hassan@email.com',
                    address: '789 Kandy Road, Kadawatha',
                    medicalHistory: 'Coronary artery disease, Previous MI (2018), Chronic kidney disease stage 3',
                    currentMedications: 'Clopidogrel 75mg OD, Atorvastatin 40mg OD, Ramipril 5mg OD',
                    allergies: 'None known',
                    emergencyContact: 'Fatima Hassan - +94773456790',
                    lastVisit: '2024-08-12',
                    status: 'Active',
                    registrationDate: '2018-01-20'
                }
            ];

            prescriptions = [
                {
                    id: 'RX001',
                    patientId: 'P001',
                    patientName: 'John Doe',
                    prescribingDoctor: 'Dr. Sarah Johnson',
                    medication: 'Metformin',
                    dosage: '500mg',
                    frequency: 'Twice daily',
                    duration: 30,
                    quantity: 60,
                    route: 'Oral',
                    prescribedDate: '2024-08-10',
                    instructions: 'Take with meals to reduce GI side effects',
                    warnings: 'Monitor for signs of lactic acidosis. Avoid alcohol.',
                    status: 'Active',
                    refillsRemaining: 2
                },
                {
                    id: 'RX002',
                    patientId: 'P002',
                    patientName: 'Maria Silva',
                    prescribingDoctor: 'Dr. Michael Chen',
                    medication: 'Salbutamol Inhaler',
                    dosage: '100mcg per puff',
                    frequency: 'As needed',
                    duration: 90,
                    quantity: 1,
                    route: 'Inhaled',
                    prescribedDate: '2024-08-08',
                    instructions: 'Use during asthma attacks. Rinse mouth after use.',
                    warnings: 'May cause tremor and palpitations. Seek emergency care if no improvement.',
                    status: 'Active',
                    refillsRemaining: 1
                },
                {
                    id: 'RX003',
                    patientId: 'P003',
                    patientName: 'Ahmed Hassan',
                    prescribingDoctor: 'Dr. Emily Rodriguez',
                    medication: 'Clopidogrel',
                    dosage: '75mg',
                    frequency: 'Once daily',
                    duration: 30,
                    quantity: 30,
                    route: 'Oral',
                    prescribedDate: '2024-08-12',
                    instructions: 'Take at the same time each day, preferably with food',
                    warnings: 'Bleeding risk. Report unusual bruising or bleeding.',
                    status: 'Active',
                    refillsRemaining: 3
                }
            ];

            inventory = [
                {
                    id: 'INV001',
                    name: 'Metformin 500mg',
                    genericName: 'Metformin Hydrochloride',
                    category: 'Prescription',
                    supplier: 'PharmaCorp Ltd',
                    batchNumber: 'MET2024001',
                    stockLevel: 150,
                    unitPrice: 0.50,
                    sellingPrice: 0.85,
                    minStockLevel: 50,
                    mfgDate: '2024-02-20',
                    expiryDate: '2025-06-30',
                    storageConditions: 'Room Temperature',
                    description: 'Bronchodilator for asthma and COPD',
                    status: 'Low Stock'
                },
                {
                    id: 'INV003',
                    name: 'Paracetamol 500mg',
                    genericName: 'Acetaminophen',
                    category: 'OTC',
                    supplier: 'HealthMeds Co',
                    batchNumber: 'PAR2024003',
                    stockLevel: 300,
                    unitPrice: 0.25,
                    sellingPrice: 0.45,
                    minStockLevel: 100,
                    mfgDate: '2024-03-10',
                    expiryDate: '2026-03-15',
                    storageConditions: 'Room Temperature',
                    description: 'Analgesic and antipyretic',
                    status: 'In Stock'
                },
                {
                    id: 'INV004',
                    name: 'Clopidogrel 75mg',
                    genericName: 'Clopidogrel Bisulfate',
                    category: 'Prescription',
                    supplier: 'CardioPharm Ltd',
                    batchNumber: 'CLO2024004',
                    stockLevel: 80,
                    unitPrice: 2.50,
                    sellingPrice: 4.25,
                    minStockLevel: 40,
                    mfgDate: '2024-01-25',
                    expiryDate: '2025-08-30',
                    storageConditions: 'Room Temperature',
                    description: 'Antiplatelet medication',
                    status: 'In Stock'
                },
                {
                    id: 'INV005',
                    name: 'Insulin Glargine',
                    genericName: 'Insulin Glargine',
                    category: 'Prescription',
                    supplier: 'DiabetesCare Inc',
                    batchNumber: 'INS2024005',
                    stockLevel: 12,
                    unitPrice: 85.00,
                    sellingPrice: 125.00,
                    minStockLevel: 15,
                    mfgDate: '2024-04-01',
                    expiryDate: '2025-04-01',
                    storageConditions: 'Refrigerated',
                    description: 'Long-acting insulin for diabetes management',
                    status: 'Low Stock'
                }
            ];

            updateDashboardStats();
            populatePatientDropdown();
            logActivity('System', 'Sample data initialized', 'System', 'Success');
        }

        // Authentication System
        function login() {
            const role = document.getElementById('userRole').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!role || !username || !password) {
                showNotification('Please fill in all fields', 'danger');
                return;
            }

            // Enhanced authentication simulation
            const validCredentials = {
                'admin': 'admin123',
                'pharmacist': 'pharma123',
                'it_operator': 'it123',
                'representative': 'rep123',
                'healthcare_provider': 'health123'
            };

            if (validCredentials[role] && password === validCredentials[role]) {
                currentUser = username;
                currentRole = role;
                
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('currentUser').textContent = username;
                document.getElementById('currentRole').textContent = formatRole(role);
                document.getElementById('userAvatar').textContent = username.charAt(0).toUpperCase();
                
                updateNavigationAccess();
                logActivity('Authentication', 'User logged in', username, 'Success');
                showNotification(`Welcome back, ${username}!`, 'success');
                
                // Start session management
                startSessionManager();
            } else {
                showNotification('Invalid credentials. Try: admin/admin123, pharmacist/pharma123, etc.', 'danger');
                logActivity('Authentication', 'Failed login attempt', username, 'Failed');
            }
        }

        function logout() {
            if (currentUser) {
                logActivity('Authentication', 'User logged out', currentUser, 'Success');
            }
            
            currentUser = null;
            currentRole = null;
            
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('userRole').value = '';
            
            updateNavigationAccess();
            showPanel('dashboard');
            showNotification('Logged out successfully', 'info');
            
            // Stop session manager
            clearTimeout(sessionTimeout);
        }

        function formatRole(role) {
            return role.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function updateNavigationAccess() {
            const tabs = {
                emrTab: document.getElementById('emrTab'),
                prescTab: document.getElementById('prescTab'),
                inventoryTab: document.getElementById('inventoryTab'),
                reportsTab: document.getElementById('reportsTab'),
                settingsTab: document.getElementById('settingsTab')
            };

            // Hide all tabs initially
            Object.values(tabs).forEach(tab => tab.style.display = 'none');

            if (!currentRole) return;

            // Role-based access control
            const permissions = {
                admin: ['emrTab', 'prescTab', 'inventoryTab', 'reportsTab', 'settingsTab'],
                pharmacist: ['emrTab', 'prescTab', 'inventoryTab', 'reportsTab'],
                healthcare_provider: ['emrTab', 'prescTab', 'reportsTab'],
                it_operator: ['inventoryTab', 'reportsTab', 'settingsTab'],
                representative: ['inventoryTab', 'reportsTab']
            };

            permissions[currentRole]?.forEach(tabId => {
                if (tabs[tabId]) tabs[tabId].style.display = 'block';
            });
        }

        // Session Management
        let sessionTimeout;
        function startSessionManager() {
            resetSessionTimer();
            // Add activity listeners
            ['click', 'keypress', 'mousemove'].forEach(event => {
                document.addEventListener(event, resetSessionTimer);
            });
        }

        function resetSessionTimer() {
            clearTimeout(sessionTimeout);
            if (currentUser) {
                sessionTimeout = setTimeout(() => {
                    showNotification('Session expired due to inactivity', 'warning');
                    logout();
                }, systemSettings.sessionTimeout * 60 * 1000);
            }
        }

        // Panel Management
        function showPanel(panelName) {
            if (!currentUser && panelName !== 'dashboard') {
                showNotification('Please login to access this system', 'warning');
                return;
            }

            // Check role permissions
            const rolePermissions = {
                emr: ['admin', 'pharmacist', 'healthcare_provider'],
                prescriptions: ['admin', 'pharmacist', 'healthcare_provider'],
                inventory: ['admin', 'pharmacist', 'it_operator', 'representative'],
                reports: ['admin', 'pharmacist', 'healthcare_provider', 'it_operator', 'representative'],
                settings: ['admin', 'it_operator']
            };

            if (panelName !== 'dashboard' && currentRole && !rolePermissions[panelName]?.includes(currentRole)) {
                showNotification('Access denied for your role', 'danger');
                return;
            }

            // Hide all panels
            document.querySelectorAll('.system-panel').forEach(panel => {
                panel.classList.add('hidden');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected panel and activate tab
            document.getElementById(panelName + 'Panel').classList.remove('hidden');
            if (event && event.target) {
                event.target.classList.add('active');
            }

            // Load data for the selected panel
            switch(panelName) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'emr':
                    loadPatients();
                    break;
                case 'prescriptions':
                    loadPrescriptions();
                    break;
                case 'inventory':
                    loadInventory();
                    break;
                case 'reports':
                    // Reports panel is static for now
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        // Dashboard Functions
        function updateDashboard() {
            updateDashboardStats();
            loadActivityLog();
            checkSystemAlerts();
        }

        function refreshDashboard() {
            showNotification('Dashboard refreshed', 'success');
            updateDashboard();
        }

        function updateDashboardStats() {
            document.getElementById('totalPatients').textContent = patients.length;
            document.getElementById('activePrescriptions').textContent = prescriptions.filter(p => p.status === 'Active').length;
            document.getElementById('inventoryItems').textContent = inventory.length;
            document.getElementById('lowStockItems').textContent = inventory.filter(item => item.stockLevel <= item.minStockLevel).length;
        }

        function loadActivityLog() {
            const tbody = document.getElementById('activityLog');
            tbody.innerHTML = '';
            
            const recentLogs = activityLog.slice(-10).reverse();
            
            if (recentLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No recent activity</td></tr>';
                return;
            }
            
            recentLogs.forEach(log => {
                const row = tbody.insertRow();
                const statusClass = log.status.toLowerCase() === 'success' ? 'active' : 
                                  log.status.toLowerCase() === 'failed' ? 'danger' : 'warning';
                row.innerHTML = `
                    <td>${log.time}</td>
                    <td>${log.system}</td>
                    <td>${log.action}</td>
                    <td>${log.user}</td>
                    <td><span class="status-badge status-${statusClass}">${log.status}</span></td>
                `;
            });
        }

        function checkSystemAlerts() {
            const alertsDiv = document.getElementById('systemAlerts');
            alertsDiv.innerHTML = '';

            const alerts = [];

            // Low stock alerts
            const lowStockItems = inventory.filter(item => item.stockLevel <= item.minStockLevel);
            if (lowStockItems.length > 0) {
                alerts.push({
                    type: 'warning',
                    icon: '📉',
                    message: `${lowStockItems.length} items need restocking`,
                    action: 'checkLowStock()'
                });
            }

            // Expiring medications
            const today = new Date();
            const thirtyDaysFromNow = new Date(today.getTime() + (30 * 24 * 60 * 60 * 1000));
            const expiringItems = inventory.filter(item => new Date(item.expiryDate) <= thirtyDaysFromNow);
            if (expiringItems.length > 0) {
                alerts.push({
                    type: 'danger',
                    icon: '⏰',
                    message: `${expiringItems.length} items expiring within 30 days`,
                    action: 'expiryAlert()'
                });
            }

            // Prescription renewals needed
            const prescriptionsNeedingRenewal = prescriptions.filter(p => p.refillsRemaining <= 1);
            if (prescriptionsNeedingRenewal.length > 0) {
                alerts.push({
                    type: 'info',
                    icon: '🔄',
                    message: `${prescriptionsNeedingRenewal.length} prescriptions need renewal`,
                    action: 'renewalReminders()'
                });
            }

            // Display alerts
            alerts.forEach(alert => {
                alertsDiv.innerHTML += `
                    <div class="alert alert-${alert.type}" onclick="${alert.action}" style="cursor: pointer;">
                        <span style="font-size: 1.2em; margin-right: 10px;">${alert.icon}</span>
                        <strong>${alert.message}</strong>
                    </div>
                `;
            });
        }

        // Patient Management Functions
        function loadPatients() {
            const tbody = document.getElementById('patientsTable');
            tbody.innerHTML = '';
            
            if (patients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No patients registered</td></tr>';
                return;
            }
            
            patients.forEach(patient => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><span class="badge">${patient.id}</span></td>
                    <td><strong>${patient.name}</strong><br><small>${patient.email}</small></td>
                    <td>${patient.age}</td>
                    <td>${patient.contact}</td>
                    <td>${patient.lastVisit}</td>
                    <td><span class="status-badge status-${patient.status.toLowerCase()}">${patient.status}</span></td>
                    <td class="table-actions">
                        <button class="btn btn-sm" onclick="viewPatient('${patient.id}')">👁️</button>
                        <button class="btn btn-sm btn-secondary" onclick="editPatient('${patient.id}')">✏️</button>
                        <button class="btn btn-sm btn-danger" onclick="deletePatient('${patient.id}')">🗑️</button>
                    </td>
                `;
            });
        }

        function addPatient(event) {
            event.preventDefault();
            
            const dob = new Date(document.getElementById('patientDOB').value);
            const today = new Date();
            const age = Math.floor((today - dob) / (365.25 * 24 * 60 * 60 * 1000));
            
            const newPatient = {
                id: 'P' + String(patients.length + 1).padStart(3, '0'),
                name: document.getElementById('patientName').value,
                dob: document.getElementById('patientDOB').value,
                age: age,
                gender: document.getElementById('patientGender').value,
                contact: document.getElementById('patientContact').value,
                email: document.getElementById('patientEmail').value,
                address: document.getElementById('patientAddress').value,
                medicalHistory: document.getElementById('medicalHistory').value,
                currentMedications: document.getElementById('currentMedications').value,
                allergies: document.getElementById('allergies').value,
                emergencyContact: document.getElementById('emergencyContact').value,
                lastVisit: new Date().toISOString().split('T')[0],
                status: 'Active',
                registrationDate: new Date().toISOString().split('T')[0]
            };

            patients.push(newPatient);
            loadPatients();
            populatePatientDropdown();
            updateDashboardStats();
            closeModal('addPatientModal');
            
            logActivity('Patient Management', `New patient registered: ${newPatient.name}`, currentUser, 'Success');
            showNotification('Patient added successfully!', 'success');
            
            // Reset form
            document.querySelector('#addPatientModal form').reset();
        }

        function searchPatients() {
            const searchTerm = document.getElementById('patientSearch').value.toLowerCase();
            const tbody = document.getElementById('patientsTable');
            tbody.innerHTML = '';
            
            const filteredPatients = patients.filter(patient => 
                patient.name.toLowerCase().includes(searchTerm) ||
                patient.id.toLowerCase().includes(searchTerm) ||
                patient.contact.includes(searchTerm) ||
                patient.email.toLowerCase().includes(searchTerm)
            );
            
            if (filteredPatients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No patients found</td></tr>';
                return;
            }
            
            filteredPatients.forEach(patient => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><span class="badge">${patient.id}</span></td>
                    <td><strong>${patient.name}</strong><br><small>${patient.email}</small></td>
                    <td>${patient.age}</td>
                    <td>${patient.contact}</td>
                    <td>${patient.lastVisit}</td>
                    <td><span class="status-badge status-${patient.status.toLowerCase()}">${patient.status}</span></td>
                    <td class="table-actions">
                        <button class="btn btn-sm" onclick="viewPatient('${patient.id}')">👁️</button>
                        <button class="btn btn-sm btn-secondary" onclick="editPatient('${patient.id}')">✏️</button>
                        <button class="btn btn-sm btn-danger" onclick="deletePatient('${patient.id}')">🗑️</button>
                    </td>
                `;
            });
        }

        function viewPatient(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;
            
            const content = `
                <div class="card">
                    <div class="form-grid">
                        <div><strong>Patient ID:</strong> ${patient.id}</div>
                        <div><strong>Name:</strong> ${patient.name}</div>
                        <div><strong>Age:</strong> ${patient.age} years</div>
                        <div><strong>Gender:</strong> ${patient.gender}</div>
                        <div><strong>Contact:</strong> ${patient.contact}</div>
                        <div><strong>Email:</strong> ${patient.email}</div>
                    </div>
                    <div style="margin-top: 20px;">
                        <div><strong>Address:</strong> ${patient.address}</div>
                        <div style="margin-top: 10px;"><strong>Medical History:</strong> ${patient.medicalHistory}</div>
                        <div style="margin-top: 10px;"><strong>Current Medications:</strong> ${patient.currentMedications}</div>
                        <div style="margin-top: 10px;"><strong>Allergies:</strong> ${patient.allergies}</div>
                        <div style="margin-top: 10px;"><strong>Emergency Contact:</strong> ${patient.emergencyContact}</div>
                        <div style="margin-top: 10px;"><strong>Registration Date:</strong> ${patient.registrationDate}</div>
                        <div style="margin-top: 10px;"><strong>Last Visit:</strong> ${patient.lastVisit}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('patientDetailsContent').innerHTML = content;
            showModal('patientDetailsModal');
            logActivity('Patient Management', `Viewed patient ${patient.name}`, currentUser, 'Success');
        }

        function editPatient(patientId) {
            showNotification('Edit functionality would open detailed patient edit form', 'info');
            logActivity('Patient Management', `Attempted to edit patient ${patientId}`, currentUser, 'Success');
        }

        function deletePatient(patientId) {
            if (confirm('Are you sure you want to delete this patient? This action cannot be undone.')) {
                const patientIndex = patients.findIndex(p => p.id === patientId);
                if (patientIndex > -1) {
                    const patientName = patients[patientIndex].name;
                    patients.splice(patientIndex, 1);
                    loadPatients();
                    populatePatientDropdown();
                    updateDashboardStats();
                    logActivity('Patient Management', `Deleted patient ${patientName}`, currentUser, 'Success');
                    showNotification('Patient deleted successfully', 'success');
                }
            }
        }

        function exportPatients() {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "ID,Name,Age,Gender,Contact,Email,Address,Medical History,Allergies\n" +
                patients.map(p => `${p.id},${p.name},${p.age},${p.gender},${p.contact},${p.email},"${p.address}","${p.medicalHistory}","${p.allergies}"`).join('\n');
            
            const link = document.createElement("a");
            link.href = encodeURI(csvContent);
            link.download = `patients_export_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            logActivity('Patient Management', 'Exported patient data', currentUser, 'Success');
            showNotification('Patient data exported successfully', 'success');
        }

        function bulkImport() {
            showNotification('Bulk import functionality would allow CSV/Excel import', 'info');
        }

        function generatePatientReport() {
            const report = {
                totalPatients: patients.length,
                ageGroups: {
                    '0-17': patients.filter(p => p.age < 18).length,
                    '18-39': patients.filter(p => p.age >= 18 && p.age < 40).length,
                    '40-59': patients.filter(p => p.age >= 40 && p.age < 60).length,
                    '60+': patients.filter(p => p.age >= 60).length
                },
                genderDistribution: {
                    Male: patients.filter(p => p.gender === 'Male').length,
                    Female: patients.filter(p => p.gender === 'Female').length,
                    Other: patients.filter(p => p.gender === 'Other').length
                }
            };
            
            alert(`Patient Demographics Report\n\nTotal Patients: ${report.totalPatients}\n\nAge Groups:\n0-17 years: ${report.ageGroups['0-17']}\n18-39 years: ${report.ageGroups['18-39']}\n40-59 years: ${report.ageGroups['40-59']}\n60+ years: ${report.ageGroups['60+']}\n\nGender Distribution:\nMale: ${report.genderDistribution.Male}\nFemale: ${report.genderDistribution.Female}\nOther: ${report.genderDistribution.Other}`);
            
            logActivity('Reports', 'Generated patient demographics report', currentUser, 'Success');
        }

        // Prescription Management Functions
        function loadPrescriptions() {
            const tbody = document.getElementById('prescriptionsTable');
            tbody.innerHTML = '';
            
            if (prescriptions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No prescriptions found</td></tr>';
                return;
            }
            
            prescriptions.forEach(prescription => {
                const row = tbody.insertRow();
                const statusClass = prescription.status.toLowerCase() === 'active' ? 'active' : 'warning';
                row.innerHTML = `
                    <td><span class="badge">${prescription.id}</span></td>
                    <td><strong>${prescription.patientName}</strong><br><small>Dr. ${prescription.prescribingDoctor}</small></td>
                    <td>${prescription.medication}</td>
                    <td>${prescription.dosage}</td>
                    <td>${prescription.prescribedDate}</td>
                    <td><span class="status-badge status-${statusClass}">${prescription.status}</span></td>
                    <td class="table-actions">
                        <button class="btn btn-sm" onclick="viewPrescription('${prescription.id}')">👁️</button>
                        <button class="btn btn-sm btn-secondary" onclick="editPrescription('${prescription.id}')">✏️</button>
                        <button class="btn btn-sm btn-success" onclick="fillPrescription('${prescription.id}')">💊</button>
                    </td>
                `;
            });
        }

        function addPrescription(event) {
            event.preventDefault();
            
            const patientId = document.getElementById('prescriptionPatient').value;
            const patient = patients.find(p => p.id === patientId);
            
            const newPrescription = {
                id: 'RX' + String(prescriptions.length + 1).padStart(3, '0'),
                patientId: patientId,
                patientName: patient.name,
                prescribingDoctor: document.getElementById('prescribingDoctor').value,
                medication: document.getElementById('medication').value,
                dosage: document.getElementById('dosage').value,
                frequency: document.getElementById('frequency').value,
                duration: parseInt(document.getElementById('duration').value),
                quantity: parseInt(document.getElementById('quantity').value),
                route: document.getElementById('route').value,
                prescribedDate: new Date().toISOString().split('T')[0],
                instructions: document.getElementById('instructions').value,
                warnings: document.getElementById('warnings').value,
                status: 'Active',
                refillsRemaining: 3
            };

            prescriptions.push(newPrescription);
            loadPrescriptions();
            updateDashboardStats();
            closeModal('addPrescriptionModal');
            
            logActivity('Prescription Management', `New prescription added: ${newPrescription.medication} for ${patient.name}`, currentUser, 'Success');
            showNotification('Prescription added successfully!', 'success');
            
            // Reset form
            document.querySelector('#addPrescriptionModal form').reset();
        }

        function populatePatientDropdown() {
            const select = document.getElementById('prescriptionPatient');
            select.innerHTML = '<option value="">Select Patient</option>';
            
            patients.forEach(patient => {
                const option = document.createElement('option');
                option.value = patient.id;
                option.textContent = `${patient.name} (${patient.id})`;
                select.appendChild(option);
            });
        }

        function searchPrescriptions() {
            const searchTerm = document.getElementById('prescriptionSearch').value.toLowerCase();
            const tbody = document.getElementById('prescriptionsTable');
            tbody.innerHTML = '';
            
            const filteredPrescriptions = prescriptions.filter(prescription => 
                prescription.patientName.toLowerCase().includes(searchTerm) ||
                prescription.medication.toLowerCase().includes(searchTerm) ||
                prescription.id.toLowerCase().includes(searchTerm) ||
                prescription.prescribingDoctor.toLowerCase().includes(searchTerm)
            );
            
            if (filteredPrescriptions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No prescriptions found</td></tr>';
                return;
            }
            
            filteredPrescriptions.forEach(prescription => {
                const row = tbody.insertRow();
                const statusClass = prescription.status.toLowerCase() === 'active' ? 'active' : 'warning';
                row.innerHTML = `
                    <td><span class="badge">${prescription.id}</span></td>
                    <td><strong>${prescription.patientName}</strong><br><small>Dr. ${prescription.prescribingDoctor}</small></td>
                    <td>${prescription.medication}</td>
                    <td>${prescription.dosage}</td>
                    <td>${prescription.prescribedDate}</td>
                    <td><span class="status-badge status-${statusClass}">${prescription.status}</span></td>
                    <td class="table-actions">
                        <button class="btn btn-sm" onclick="viewPrescription('${prescription.id}')">👁️</button>
                        <button class="btn btn-sm btn-secondary" onclick="editPrescription('${prescription.id}')">✏️</button>
                        <button class="btn btn-sm btn-success" onclick="fillPrescription('${prescription.id}')">💊</button>
                    </td>
                `;
            });
        }

        function viewPrescription(prescriptionId) {
            const prescription = prescriptions.find(p => p.id === prescriptionId);
            if (!prescription) return;
            
            alert(`Prescription Details:\n\nID: ${prescription.id}\nPatient: ${prescription.patientName}\nDoctor: Dr. ${prescription.prescribingDoctor}\nMedication: ${prescription.medication}\nDosage: ${prescription.dosage}\nFrequency: ${prescription.frequency}\nRoute: ${prescription.route}\nDuration: ${prescription.duration} days\nQuantity: ${prescription.quantity}\nInstructions: ${prescription.instructions}\nWarnings: ${prescription.warnings}\nRefills Remaining: ${prescription.refillsRemaining}`);
            
            logActivity('Prescription Management', `Viewed prescription ${prescription.id}`, currentUser, 'Success');
        }

        function editPrescription(prescriptionId) {
            showNotification('Edit functionality would open detailed prescription edit form', 'info');
        }

        function fillPrescription(prescriptionId) {
            const prescription = prescriptions.find(p => p.id === prescriptionId);
            if (!prescription) return;
            
            if (confirm(`Fill prescription ${prescription.id} for ${prescription.patientName}?\nMedication: ${prescription.medication} ${prescription.dosage}`)) {
                // Check if medication is in stock
                const inventoryItem = inventory.find(item => 
                    item.name.toLowerCase().includes(prescription.medication.toLowerCase())
                );
                
                if (inventoryItem) {
                    if (inventoryItem.stockLevel >= prescription.quantity) {
                        inventoryItem.stockLevel -= prescription.quantity;
                        if (inventoryItem.stockLevel <= inventoryItem.minStockLevel) {
                            inventoryItem.status = 'Low Stock';
                        }
                        
                        prescription.refillsRemaining--;
                        if (prescription.refillsRemaining <= 0) {
                            prescription.status = 'Completed';
                        }
                        
                        loadPrescriptions();
                        loadInventory();
                        updateDashboardStats();
                        
                        logActivity('Prescription Management', `Filled prescription ${prescription.id}`, currentUser, 'Success');
                        showNotification('Prescription filled successfully', 'success');
                    } else {
                        showNotification('Insufficient stock to fill prescription', 'danger');
                    }
                } else {
                    showNotification('Medication not found in inventory', 'warning');
                }
            }
        }

        function checkInteractions() {
            // Simulate drug interaction checking
            showNotification('Drug interaction check completed - No major interactions found', 'success');
            logActivity('Prescription Management', 'Performed drug interaction check', currentUser, 'Success');
        }

        function renewalReminders() {
            const needsRenewal = prescriptions.filter(p => p.refillsRemaining <= 1 && p.status === 'Active');
            if (needsRenewal.length > 0) {
                const reminderList = needsRenewal.map(p => `${p.patientName} - ${p.medication}`).join('\n');
                alert(`Prescriptions Needing Renewal:\n\n${reminderList}`);
                logActivity('Prescription Management', 'Generated renewal reminders', currentUser, 'Success');
            } else {
                showNotification('No prescriptions need renewal at this time', 'info');
            }
        }

        function generatePrescriptionReport() {
            const report = {
                total: prescriptions.length,
                active: prescriptions.filter(p => p.status === 'Active').length,
                completed: prescriptions.filter(p => p.status === 'Completed').length,
                topMedications: {}
            };
            
            prescriptions.forEach(p => {
                report.topMedications[p.medication] = (report.topMedications[p.medication] || 0) + 1;
            });
            
            const topMeds = Object.entries(report.topMedications)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5)
                .map(([med, count]) => `${med}: ${count}`)
                .join('\n');
            
            alert(`Prescription Analytics Report\n\nTotal Prescriptions: ${report.total}\nActive: ${report.active}\nCompleted: ${report.completed}\n\nTop 5 Medications:\n${topMeds}`);
            
            logActivity('Reports', 'Generated prescription analytics report', currentUser, 'Success');
        }

        // Inventory Management Functions
        function loadInventory() {
            const tbody = document.getElementById('inventoryTable');
            tbody.innerHTML = '';
            
            if (inventory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No inventory items found</td></tr>';
                return;
            }
            
            inventory.forEach(item => {
                const row = tbody.insertRow();
                const statusClass = item.status === 'Low Stock' ? 'warning' : 
                                  item.status === 'Out of Stock' ? 'danger' : 'active';
                row.innerHTML = `
                    <td><span class="badge">${item.id}</span></td>
                    <td><strong>${item.name}</strong><br><small>${item.genericName}</small></td>
                    <td>${item.supplier}<br><small>Batch: ${item.batchNumber}</small></td>
                    <td>${item.stockLevel}</td>
                    <td>${item.sellingPrice.toFixed(2)}<br><small>Cost: ${item.unitPrice.toFixed(2)}</small></td>
                    <td>${item.expiryDate}</td>
                    <td><span class="status-badge status-${statusClass}">${item.status}</span></td>
                    <td class="table-actions">
                        <button class="btn btn-sm" onclick="viewInventoryItem('${item.id}')">👁️</button>
                        <button class="btn btn-sm btn-secondary" onclick="editInventoryItem('${item.id}')">✏️</button>
                        <button class="btn btn-sm btn-success" onclick="restockItem('${item.id}')">📦</button>
                    </td>
                `;
            });
        }

        function addInventoryItem(event) {
            event.preventDefault();
            
            const stockLevel = parseInt(document.getElementById('stockQuantity').value);
            const minLevel = parseInt(document.getElementById('minStockLevel').value);
            
            const newItem = {
                id: 'INV' + String(inventory.length + 1).padStart(3, '0'),
                name: document.getElementById('itemName').value,
                genericName: document.getElementById('genericName').value,
                category: document.getElementById('itemCategory').value,
                supplier: document.getElementById('supplier').value,
                batchNumber: document.getElementById('batchNumber').value,
                stockLevel: stockLevel,
                unitPrice: parseFloat(document.getElementById('unitPrice').value),
                sellingPrice: parseFloat(document.getElementById('sellingPrice').value),
                minStockLevel: minLevel,
                mfgDate: document.getElementById('mfgDate').value,
                expiryDate: document.getElementById('expiryDate').value,
                storageConditions: document.getElementById('storageConditions').value,
                description: document.getElementById('itemDescription').value,
                status: stockLevel <= minLevel ? 'Low Stock' : 'In Stock'
            };

            inventory.push(newItem);
            loadInventory();
            updateDashboardStats();
            closeModal('addInventoryModal');
            
            logActivity('Inventory Management', `New item added: ${newItem.name}`, currentUser, 'Success');
            showNotification('Inventory item added successfully!', 'success');
            
            // Reset form
            document.querySelector('#addInventoryModal form').reset();
        }

        function searchInventory() {
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            const tbody = document.getElementById('inventoryTable');
            tbody.innerHTML = '';
            
            const filteredInventory = inventory.filter(item => 
                item.name.toLowerCase().includes(searchTerm) ||
                item.genericName.toLowerCase().includes(searchTerm) ||
                item.supplier.toLowerCase().includes(searchTerm) ||
                item.category.toLowerCase().includes(searchTerm) ||
                item.id.toLowerCase().includes(searchTerm)
            );
            
            if (filteredInventory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No items found</td></tr>';
                return;
            }
            
            filteredInventory.forEach(item => {
                const row = tbody.insertRow();
                const statusClass = item.status === 'Low Stock' ? 'warning' : 
                                  item.status === 'Out of Stock' ? 'danger' : 'active';
                row.innerHTML = `
                    <td><span class="badge">${item.id}</span></td>
                    <td><strong>${item.name}</strong><br><small>${item.genericName}</small></td>
                    <td>${item.supplier}<br><small>Batch: ${item.batchNumber}</small></td>
                    <td>${item.stockLevel}</td>
                    <td>${item.sellingPrice.toFixed(2)}<br><small>Cost: ${item.unitPrice.toFixed(2)}</small></td>
                    <td>${item.expiryDate}</td>
                    <td><span class="status-badge status-${statusClass}">${item.status}</span></td>
                    <td class="table-actions">
                        <button class="btn btn-sm" onclick="viewInventoryItem('${item.id}')">👁️</button>
                        <button class="btn btn-sm btn-secondary" onclick="editInventoryItem('${item.id}')">✏️</button>
                        <button class="btn btn-sm btn-success" onclick="restockItem('${item.id}')">📦</button>
                    </td>
                `;
            });
        }

        function viewInventoryItem(itemId) {
            const item = inventory.find(i => i.id === itemId);
            if (!item) return;
            
            const profitMargin = ((item.sellingPrice - item.unitPrice) / item.unitPrice * 100).toFixed(1);
            const totalValue = (item.stockLevel * item.sellingPrice).toFixed(2);
            
            alert(`Inventory Item Details:\n\nID: ${item.id}\nName: ${item.name}\nGeneric: ${item.genericName}\nCategory: ${item.category}\nSupplier: ${item.supplier}\nBatch: ${item.batchNumber}\nStock Level: ${item.stockLevel}\nMin Level: ${item.minStockLevel}\nUnit Cost: ${item.unitPrice.toFixed(2)}\nSelling Price: ${item.sellingPrice.toFixed(2)}\nProfit Margin: ${profitMargin}%\nTotal Value: ${totalValue}\nMfg Date: ${item.mfgDate}\nExpiry Date: ${item.expiryDate}\nStorage: ${item.storageConditions}\nDescription: ${item.description}`);
            
            logActivity('Inventory Management', `Viewed inventory item ${item.name}`, currentUser, 'Success');
        }

        function editInventoryItem(itemId) {
            showNotification('Edit functionality would open detailed inventory edit form', 'info');
        }

        function restockItem(itemId) {
            const item = inventory.find(i => i.id === itemId);
            if (!item) return;
            
            const quantity = prompt(`Restock ${item.name}\nCurrent stock: ${item.stockLevel}\nMinimum level: ${item.minStockLevel}\n\nEnter quantity to add:`);
            
            if (quantity && !isNaN(quantity) && parseInt(quantity) > 0) {
                const addedQty = parseInt(quantity);
                item.stockLevel += addedQty;
                
                if (item.stockLevel > item.minStockLevel) {
                    item.status = 'In Stock';
                }
                
                loadInventory();
                updateDashboardStats();
                
                logActivity('Inventory Management', `Restocked ${item.name}: +${addedQty} units`, currentUser, 'Success');
                showNotification(`Successfully added ${addedQty} units to ${item.name}`, 'success');
            }
        }

        function generateFinancialReport() {
            const totalValue = inventory.reduce((sum, item) => sum + (item.stockLevel * item.sellingPrice), 0);
            const totalCost = inventory.reduce((sum, item) => sum + (item.stockLevel * item.unitPrice), 0);
            const potentialProfit = totalValue - totalCost;
            const lowStockValue = inventory.filter(item => item.stockLevel <= item.minStockLevel)
                .reduce((sum, item) => sum + (item.stockLevel * item.sellingPrice), 0);
            
            const categoryBreakdown = {};
            inventory.forEach(item => {
                if (!categoryBreakdown[item.category]) {
                    categoryBreakdown[item.category] = { items: 0, value: 0 };
                }
                categoryBreakdown[item.category].items++;
                categoryBreakdown[item.category].value += item.stockLevel * item.sellingPrice;
            });
            
            const categoryReport = Object.entries(categoryBreakdown)
                .map(([cat, data]) => `${cat}: ${data.items} items, ${data.value.toFixed(2)}`)
                .join('\n');
            
            const report = `Financial Inventory Report - ${new Date().toLocaleDateString()}\n\nTotal Inventory Value: ${totalValue.toFixed(2)}\nTotal Cost: ${totalCost.toFixed(2)}\nPotential Profit: ${potentialProfit.toFixed(2)} (${((potentialProfit/totalCost)*100).toFixed(1)}%)\nLow Stock Value: ${lowStockValue.toFixed(2)}\nTotal Items: ${inventory.length}\nLow Stock Items: ${inventory.filter(item => item.stockLevel <= item.minStockLevel).length}\n\nCategory Breakdown:\n${categoryReport}`;
            
            alert(report);
            logActivity('Reports', 'Generated financial inventory report', currentUser, 'Success');
        }

        function checkLowStock() {
            const lowStockItems = inventory.filter(item => item.stockLevel <= item.minStockLevel);
            
            if (lowStockItems.length === 0) {
                showNotification('All items are adequately stocked!', 'success');
            } else {
                const itemsList = lowStockItems.map(item => 
                    `${item.name} (${item.stockLevel}/${item.minStockLevel}) - ${item.supplier}`
                ).join('\n');
                alert(`Low Stock Items (${lowStockItems.length}):\n\n${itemsList}`);
                logActivity('Inventory Management', 'Low stock check performed', currentUser, 'Warning');
            }
        }

        function expiryAlert() {
            const today = new Date();
            const thirtyDays = new Date(today.getTime() + (30 * 24 * 60 * 60 * 1000));
            const sixtyDays = new Date(today.getTime() + (60 * 24 * 60 * 60 * 1000));
            
            const expiredItems = inventory.filter(item => new Date(item.expiryDate) <= today);
            const expiringSoon = inventory.filter(item => {
                const expiry = new Date(item.expiryDate);
                return expiry > today && expiry <= thirtyDays;
            });
            const expiringLater = inventory.filter(item => {
                const expiry = new Date(item.expiryDate);
                return expiry > thirtyDays && expiry <= sixtyDays;
            });
            
            let alertMessage = `Expiry Alert Report - ${new Date().toLocaleDateString()}\n\n`;
            
            if (expiredItems.length > 0) {
                alertMessage += `🚨 EXPIRED (${expiredItems.length}):\n`;
                alertMessage += expiredItems.map(item => `${item.name} - Expired: ${item.expiryDate}`).join('\n') + '\n\n';
            }
            
            if (expiringSoon.length > 0) {
                alertMessage += `⚠️ EXPIRING WITHIN 30 DAYS (${expiringSoon.length}):\n`;
                alertMessage += expiringSoon.map(item => `${item.name} - Expires: ${item.expiryDate}`).join('\n') + '\n\n';
            }
            
            if (expiringLater.length > 0) {
                alertMessage += `📅 EXPIRING 30-60 DAYS (${expiringLater.length}):\n`;
                alertMessage += expiringLater.map(item => `${item.name} - Expires: ${item.expiryDate}`).join('\n');
            }
            
            if (expiredItems.length === 0 && expiringSoon.length === 0 && expiringLater.length === 0) {
                alertMessage += '✅ No items expiring within 60 days';
            }
            
            alert(alertMessage);
            logActivity('Inventory Management', 'Performed expiry alert check', currentUser, 'Success');
        }

        function stockOptimization() {
            const recommendations = [];
            
            inventory.forEach(item => {
                if (item.stockLevel <= item.minStockLevel) {
                    recommendations.push(`📈 RESTOCK: ${item.name} (${item.stockLevel}/${item.minStockLevel})`);
                } else if (item.stockLevel > item.minStockLevel * 3) {
                    recommendations.push(`📉 OVERSTOCK: ${item.name} (${item.stockLevel}/${item.minStockLevel})`);
                }
                
                const daysToExpiry = Math.floor((new Date(item.expiryDate) - new Date()) / (24 * 60 * 60 * 1000));
                if (daysToExpiry < 90 && item.stockLevel > item.minStockLevel) {
                    recommendations.push(`⏰ PRIORITY SALE: ${item.name} (expires in ${daysToExpiry} days)`);
                }
            });
            
            if (recommendations.length === 0) {
                showNotification('Stock levels are optimized!', 'success');
            } else {
                alert(`Stock Optimization Recommendations:\n\n${recommendations.join('\n')}`);
            }
            
            logActivity('Inventory Management', 'Performed stock optimization analysis', currentUser, 'Success');
        }

        // Reports Functions
        function generateSalesReport() {
            showNotification('Generating comprehensive sales analytics...', 'info');
            setTimeout(() => {
                showNotification('Sales report generated successfully', 'success');
                logActivity('Reports', 'Generated sales analytics report', currentUser, 'Success');
            }, 2000);
        }

        function generateInventoryReport() {
            generateFinancialReport();
        }

        function generateComplianceReport() {
            const expiredCount = inventory.filter(item => new Date(item.expiryDate) <= new Date()).length;
            const lowStockCount = inventory.filter(item => item.stockLevel <= item.minStockLevel).length;
            const controlledSubstances = inventory.filter(item => item.category === 'Prescription').length;
            
            alert(`Regulatory Compliance Report\n\nExpired Items: ${expiredCount} ${expiredCount > 0 ? '❌' : '✅'}\nLow Stock Items: ${lowStockCount}\nControlled Substances: ${controlledSubstances}\n\nCompliance Status: ${expiredCount === 0 ? 'COMPLIANT ✅' : 'ATTENTION REQUIRED ⚠️'}\n\nRecommendations:\n${expiredCount > 0 ? '• Remove expired items from inventory\n' : ''}${lowStockCount > 0 ? '• Restock low inventory items\n' : ''}• Regular inventory audits recommended`);
            
            logActivity('Reports', 'Generated compliance report', currentUser, 'Success');
        }

        function scheduleReport() {
            showNotification('Report scheduling functionality would allow automated reports', 'info');
        }

        function generateCustomReport() {
            const reportType = document.getElementById('reportType').value;
            const dateRange = document.getElementById('dateRange').value;
            const format = document.getElementById('reportFormat').value;
            
            showNotification(`Generating ${reportType} report for ${dateRange} in ${format} format...`, 'info');
            
            setTimeout(() => {
                showNotification('Custom report generated successfully', 'success');
                logActivity('Reports', `Generated custom ${reportType} report`, currentUser, 'Success');
            }, 2000);
        }

        // Settings Functions
        function loadSettings() {
            document.getElementById('pharmacyName').value = systemSettings.pharmacyName;
            document.getElementById('sessionTimeout').value = systemSettings.sessionTimeout;
            document.getElementById('enableMFA').checked = systemSettings.enableMFA;
            document.getElementById('emailNotifications').checked = systemSettings.notifications.email;
            document.getElementById('smsNotifications').checked = systemSettings.notifications.sms;
            document.getElementById('lowStockAlerts').checked = systemSettings.notifications.lowStock;
            document.getElementById('expiryAlerts').checked = systemSettings.notifications.expiry;
        }

        function saveSettings() {
            systemSettings.pharmacyName = document.getElementById('pharmacyName').value;
            systemSettings.sessionTimeout = parseInt(document.getElementById('sessionTimeout').value);
            systemSettings.enableMFA = document.getElementById('enableMFA').checked;
            systemSettings.notifications.email = document.getElementById('emailNotifications').checked;
            systemSettings.notifications.sms = document.getElementById('smsNotifications').checked;
            systemSettings.notifications.lowStock = document.getElementById('lowStockAlerts').checked;
            systemSettings.notifications.expiry = document.getElementById('expiryAlerts').checked;
            
            showNotification('Settings saved successfully', 'success');
            logActivity('System Settings', 'Updated system settings', currentUser, 'Success');
        }

        function backupSystem() {
            showNotification('Creating system backup...', 'info');
            
            setTimeout(() => {
                const backupData = {
                    patients: patients,
                    prescriptions: prescriptions,
                    inventory: inventory,
                    settings: systemSettings,
                    timestamp: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `healthfirst_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showNotification('System backup completed', 'success');
                logActivity('System Settings', 'Created system backup', currentUser, 'Success');
            }, 2000);
        }

        function exportAllData() {
            backupSystem();
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,.csv,.xlsx';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    showNotification(`Importing data from ${file.name}...`, 'info');
                    // Simulate import process
                    setTimeout(() => {
                        showNotification('Data import completed successfully', 'success');
                        logActivity('System Settings', 'Imported data', currentUser, 'Success');
                    }, 3000);
                }
            };
            input.click();
        }

        function resetSystem() {
            if (confirm('Are you sure you want to reset the system? This will delete ALL data and cannot be undone!')) {
                if (confirm('This action is IRREVERSIBLE. Type "RESET" to confirm:') && prompt('Type RESET to confirm:') === 'RESET') {
                    patients.length = 0;
                    prescriptions.length = 0;
                    inventory.length = 0;
                    activityLog.length = 0;
                    
                    initializeSampleData();
                    updateDashboard();
                    
                    showNotification('System has been reset to initial state', 'warning');
                    logActivity('System Settings', 'System reset performed', currentUser, 'Warning');
                }
            }
        }

        // Utility Functions
        function showModal(modalId) {
            if (!currentUser && modalId !== 'patientDetailsModal') {
                showNotification('Please login to access this feature', 'warning');
                return;
            }
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification-toast`;
            
            const colors = {
                success: 'linear-gradient(135deg, #10b981, #059669)',
                danger: 'linear-gradient(135deg, #ef4444, #dc2626)', 
                warning: 'linear-gradient(135deg, #f59e0b, #d97706)',
                info: 'linear-gradient(135deg, #3b82f6, #2563eb)'
            };
            
            const icons = {
                success: '✅',
                danger: '❌',
                warning: '⚠️', 
                info: 'ℹ️'
            };
            
            notification.style.background = colors[type] || colors.info;
            notification.innerHTML = `${icons[type]} ${message}`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function logActivity(system, action, user, status) {
            activityLog.push({
                time: new Date().toLocaleTimeString(),
                date: new Date().toLocaleDateString(),
                system: system,
                action: action,
                user: user || 'System',
                status: status
            });
            
            // Keep only last 100 logs to prevent memory issues
            if (activityLog.length > 100) {
                activityLog.shift();
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            initializeSampleData();
            updateNavigationAccess();
            logActivity('System', 'HealthFirst Pharmacy System initialized', 'System', 'Success');
            showNotification('🏥 HealthFirst Pharmacy System loaded successfully!', 'success');
            
            // Auto-refresh dashboard every 5 minutes
            setInterval(() => {
                if (currentUser && document.getElementById('dashboardPanel').classList.contains('hidden') === false) {
                    updateDashboard();
                }
            }, 300000);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case '1':
                        e.preventDefault();
                        showPanel('dashboard');
                        break;
                    case '2':
                        if (currentUser) {
                            e.preventDefault();
                            showPanel('emr');
                        }
                        break;
                    case '3':
                        if (currentUser) {
                            e.preventDefault();
                            showPanel('prescriptions');
                        }
                        break;
                    case '4':
                        if (currentUser) {
                            e.preventDefault();
                            showPanel('inventory');
                        }
                        break;
                    case 'n':
                        if (currentUser && !document.getElementById('dashboardPanel').classList.contains('hidden')) {
                            e.preventDefault();
                            if (document.getElementById('emrPanel').classList.contains('hidden') === false) {
                                showModal('addPatientModal');
                            } else if (document.getElementById('prescriptionsPanel').classList.contains('hidden') === false) {
                                showModal('addPrescriptionModal');
                            } else if (document.getElementById('inventoryPanel').classList.contains('hidden') === false) {
                                showModal('addInventoryModal');
                            }
                        }
                        break;
                }
            }
            
            // ESC to close modals
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    if (modal.style.display === 'block') {
                        modal.style.display = 'none';
                    }
                });
            }
        });
    </script>
</body>
</html>-01-15',
                    expiryDate: '2025-12-31',
                    storageConditions: 'Room Temperature',
                    description: 'Antidiabetic medication for Type 2 diabetes',
                    status: 'In Stock'
                },
                {
                    id: 'INV002',
                    name: 'Salbutamol Inhaler',
                    genericName: 'Salbutamol Sulfate',
                    category: 'Prescription',
                    supplier: 'MediSupply Inc',
                    batchNumber: 'SAL2024002',
                    stockLevel: 25,
                    unitPrice: 15.00,
                    sellingPrice: 22.50,
                    minStockLevel: 30,
                    mfgDate: '2024